#!/bin/sh

export DISPLAY=:0

do_umount() {
  ls_devices_cmd="df -h | grep ^/dev | $ROFI -p \"Select the device to umount\""
  device=$(_run_user_cmd "$ls_devices_cmd")
  mount_point=$(echo "$device" | awk '{print $6}')

  if [ -s "$mount_point" ]; then
    if eval "$UMOUNT $mount_point" ; then
      notify_cmd="$NOTIFY \"Device umounted, now you can remove it safely\""

      rmdir "$mount_point"
      _run_user_cmd "$notify_cmd"
    fi
  fi
}

do_mount() {
  show_action_cmd="$ROFI -p \"Device '$2 $1' detected. Select the action\""
  action=$(printf "mount\nignore" | _run_user_cmd "$show_action_cmd")

  if [ "$action" = "mount" ]; then
    mount_point="/mnt/$2"

    mkdir -p "$mount_point"
    if eval "$MOUNT $1 $mount_point" ; then
      notify_cmd="$NOTIFY \"Device $1 mounted at $mount_point\""

      _run_user_cmd "$notify_cmd"
    fi
  fi
}

do_clean() {
  mount_point="$1"

  if [ -s "$mount_point" ]; then
    if eval "$UMOUNT $mount_point" ; then
      rmdir "$mount_point"
    fi
  fi
}

_run_user_cmd() {
  cmd=$1

  su -c "$cmd" "$USER"
}

_set_env() {
  pid_1=$(cat /proc/1/comm)

  case $pid_1 in
    systemd)
      MOUNT="systemd-mount --no-block --collect"
      UMOUNT="systemd-umount" ;;
    *)
      MOUNT="mount"
      UMOUNT="umount" ;;
  esac

  APP="usb-rofi"
  ICON="/usr/share/$APP/usb-icon.png"
  ROFI="rofi -dmenu"
  NOTIFY="notify-send $APP -i $ICON"
  USER=@@USERNAME@@
}

main() {
  _set_env

  while getopts 'd:c:u' op ; do
    case $op in
      d)
        dev_part=$(echo "$OPTARG" | cut -f1 -d":")
        dev_desc=$(echo "$OPTARG" | cut -f2 -d":")

        do_mount "$dev_part" "$dev_desc" ;;
      c) do_clean "$OPTARG" ;;
      u) do_umount ;;
      *) ;;
    esac
  done
}

main "$@"
